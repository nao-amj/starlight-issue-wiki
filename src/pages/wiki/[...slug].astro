---
import { getIssues } from '../../lib/github';
import { marked } from 'marked';
import { gfmHeadingId } from 'marked-gfm-heading-id';
import WikiContent from '../../components/WikiContent.astro';
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';

export async function getStaticPaths() {
  const issues = await getIssues();
  
  // issueからパスを生成
  return issues.map(issue => {
    // スラッグを生成（スペースをダッシュに変換、小文字に変換）
    const slug = issue.title.toLowerCase()
      .replace(/[^\w\s-]/g, '') // 特殊文字を削除
      .replace(/\s+/g, '-') // スペースをダッシュに変換
      .replace(/^-+|-+$/g, ''); // 先頭と末尾のダッシュを削除
    
    return {
      params: { slug },
      props: { issue },
    };
  });
}

const { issue } = Astro.props;

// markedのセットアップ
marked.use(gfmHeadingId());

// issueの内容をHTMLに変換（非同期処理ではなく同期的に変換）
const content = issue.body ? marked.parse(issue.body) : '';

// frontmatterの設定
const frontmatter = {
  title: issue.title,
  description: `${issue.title} - Starlight Issue Wiki`,
};

// Starlightページ用のデータを準備
const starlightProps = {
  frontmatter,
  headings: [],
  hasSidebar: true,
  dir: 'ltr',
  isFallback: false,
  lang: 'ja',
  lastUpdated: new Date(),
  pagination: { prev: undefined, next: undefined },
  sidebar: [],
  toc: { items: [] },
  entry: {},
};
---

<StarlightPage {...starlightProps}>
  <WikiContent slot="content" content={content} issueUrl={issue.html_url} />
</StarlightPage>