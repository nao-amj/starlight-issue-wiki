---
import type { GitHubIssue } from '../data/types';
import { findBidirectionalLinks } from '../lib/zettelkasten';
import { BASE_PATH } from '../config';

export interface Props {
  issues: GitHubIssue[];
  currentIssueNumber?: number;
  showFullGraph?: boolean;
}

const { issues, currentIssueNumber, showFullGraph = false } = Astro.props;

// 双方向リンクを検出
const bidirectionalLinks = findBidirectionalLinks(issues);

// グラフデータの準備
const graphData = {
  nodes: issues.map(issue => ({
    id: issue.number,
    title: issue.title,
    url: `${BASE_PATH}/wiki/${issue.number}`,
    isCurrent: issue.number === currentIssueNumber,
    labels: issue.labels ? issue.labels.map(label => 
      typeof label === 'object' ? label.name : label
    ) : [],
    state: issue.state || 'open',
    comments: issue.comments || 0,
    updated_at: issue.updated_at,
    created_at: issue.created_at
  })),
  links: []
};

// リンクデータの準備
issues.forEach(issue => {
  if (!issue.body) return;
  
  // [[...]]形式のリンクを検出
  const wikiLinks = issue.body.match(/\[\[(.*?)\]\]/g);
  if (wikiLinks) {
    wikiLinks.forEach(link => {
      const linkedTitle = link.substring(2, link.length - 2).trim();
      const linkedIssue = issues.find(i => 
        i.title.toLowerCase() === linkedTitle.toLowerCase() ||
        i.title.toLowerCase().includes(linkedTitle.toLowerCase())
      );
      
      if (linkedIssue && linkedIssue.number !== issue.number) {
        graphData.links.push({
          source: issue.number,
          target: linkedIssue.number,
          bidirectional: bidirectionalLinks.has(issue.number) && 
            bidirectionalLinks.get(issue.number)?.includes(linkedIssue.number),
          type: 'wiki'
        });
      }
    });
  }
  
  // #番号形式のリンクを検出
  const issueRefs = issue.body.match(/#(\d+)/g);
  if (issueRefs) {
    issueRefs.forEach(ref => {
      const refNumber = parseInt(ref.substring(1), 10);
      const refIssue = issues.find(i => i.number === refNumber);
      
      if (refIssue && refIssue.number !== issue.number) {
        // 重複リンクを防ぐ
        const existingLink = graphData.links.find(
          link => (link.source === issue.number && link.target === refIssue.number) ||
                 (link.source === refIssue.number && link.target === issue.number)
        );
        
        if (!existingLink) {
          graphData.links.push({
            source: issue.number,
            target: refIssue.number,
            bidirectional: bidirectionalLinks.has(issue.number) && 
              bidirectionalLinks.get(issue.number)?.includes(refIssue.number),
            type: 'reference'
          });
        }
      }
    });
  }
});

// 小さいグラフの場合はフィルタリング
let filteredGraphData = graphData;
if (!showFullGraph && currentIssueNumber) {
  // 現在のノードと直接リンクしているノードのみを表示
  const connectedNodeIds = new Set();
  connectedNodeIds.add(currentIssueNumber);
  
  graphData.links.forEach(link => {
    if (link.source === currentIssueNumber) {
      connectedNodeIds.add(link.target);
    }
    if (link.target === currentIssueNumber) {
      connectedNodeIds.add(link.source);
    }
  });
  
  filteredGraphData = {
    nodes: graphData.nodes.filter(node => connectedNodeIds.has(node.id)),
    links: graphData.links.filter(link => 
      connectedNodeIds.has(link.source) && connectedNodeIds.has(link.target)
    )
  };
}

// D3.jsにわたすデータをJSON文字列として埋め込む
const dataJson = JSON.stringify(showFullGraph ? graphData : filteredGraphData);
---

<div class="knowledge-graph-container">
  <div id="knowledge-graph" class={showFullGraph ? 'full-graph' : 'mini-graph'} data-current-id={currentIssueNumber || 0}>
    <!-- グラフはJavaScriptで描画 -->
    <div class="graph-loading">
      <span class="loading-spinner"></span>
      <span>グラフを読み込み中...</span>
    </div>
  </div>
  
  {showFullGraph && (
    <div class="graph-controls">
      <div class="graph-search">
        <div class="search-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </div>
        <input type="text" id="node-search" placeholder="ノードを検索...">
      </div>
      <div class="graph-buttons">
        <button id="zoom-in" class="graph-button" title="拡大">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            <line x1="11" y1="8" x2="11" y2="14"></line>
            <line x1="8" y1="11" x2="14" y2="11"></line>
          </svg>
        </button>
        <button id="zoom-out" class="graph-button" title="縮小">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            <line x1="8" y1="11" x2="14" y2="11"></line>
          </svg>
        </button>
        <button id="reset-graph" class="graph-button" title="リセット">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
            <path d="M3 3v5h5"></path>
          </svg>
        </button>
        <button id="toggle-legend" class="graph-button" title="凡例表示">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
        <button id="toggle-labels" class="graph-button active" title="ラベル表示">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="3" y1="9" x2="21" y2="9"></line>
            <line x1="3" y1="15" x2="21" y2="15"></line>
            <line x1="9" y1="3" x2="9" y2="21"></line>
            <line x1="15" y1="3" x2="15" y2="21"></line>
          </svg>
        </button>
        <button id="toggle-physics" class="graph-button active" title="物理シミュレーション">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="2" y1="12" x2="22" y2="12"></line>
            <line x1="12" y1="2" x2="12" y2="22"></line>
          </svg>
        </button>
        <button id="optimize-layout" class="graph-button" title="レイアウト最適化">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <circle cx="15.5" cy="8.5" r="1.5"></circle>
            <circle cx="15.5" cy="15.5" r="1.5"></circle>
            <circle cx="8.5" cy="15.5" r="1.5"></circle>
          </svg>
        </button>
      </div>
    </div>
  )}
  
  {showFullGraph && (
    <div class="graph-panel">
      <div id="graph-info" class="graph-info-panel">
        <div class="panel-header">
          <h3>グラフ情報</h3>
          <div class="panel-controls">
            <button id="toggle-panel" class="panel-toggle" title="パネルの表示/非表示">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
          </div>
        </div>
        <div class="panel-content">
          <div class="graph-stats">
            <div class="graph-stat">
              <span class="stat-label">ノード数:</span>
              <span class="stat-value">{graphData.nodes.length}</span>
            </div>
            <div class="graph-stat">
              <span class="stat-label">リンク数:</span>
              <span class="stat-value">{graphData.links.length}</span>
            </div>
            <div class="graph-stat">
              <span class="stat-label">双方向リンク:</span>
              <span class="stat-value">{graphData.links.filter(link => link.bidirectional).length}</span>
            </div>
          </div>
          <div id="node-details" class="node-details">
            <div class="no-selection">ノードを選択すると詳細が表示されます</div>
          </div>
        </div>
      </div>
    </div>
  )}
</div>

<style>
  .knowledge-graph-container {
    width: 100%;
    overflow: hidden;
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin: 1rem 0;
    position: relative;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
  }
  
  .dark .knowledge-graph-container {
    border-color: rgba(255, 255, 255, 0.1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }
  
  #knowledge-graph {
    width: 100%;
    background-color: #f9fafc;
    background-image: radial-gradient(#e3e8f5 1px, transparent 1px);
    background-size: 20px 20px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  .dark #knowledge-graph {
    background-color: #12151a;
    background-image: radial-gradient(rgba(80, 100, 150, 0.2) 1px, transparent 1px);
  }
  
  .mini-graph {
    height: 280px;
  }
  
  .full-graph {
    height: 650px;
  }
  
  .graph-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #666;
    font-size: 0.9rem;
  }
  
  .dark .graph-loading {
    color: #ccc;
  }
  
  .loading-spinner {
    display: inline-block;
    width: 36px;
    height: 36px;
    border: 3px solid rgba(79, 109, 245, 0.2);
    border-radius: 50%;
    border-top-color: var(--color-primary);
    animation: spin 0.8s ease-in-out infinite;
    margin-bottom: 0.5rem;
  }
  
  .dark .loading-spinner {
    border-color: rgba(79, 109, 245, 0.15);
    border-top-color: var(--color-primary);
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .graph-controls {
    position: absolute;
    bottom: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 10;
    transition: all 0.3s ease;
  }

  .graph-search {
    margin-bottom: 8px;
    position: relative;
    width: 220px;
  }

  .search-icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #8996a9;
  }

  .graph-search input {
    padding: 8px 10px 8px 35px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    width: 100%;
    font-size: 14px;
    background-color: white;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    transition: all 0.2s;
  }

  .graph-search input:focus {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(79, 109, 245, 0.15);
    outline: none;
  }

  .dark .graph-search input {
    background-color: #1d222b;
    border-color: rgba(255, 255, 255, 0.1);
    color: #eee;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }

  .dark .graph-search input:focus {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(79, 109, 245, 0.25);
  }

  .graph-buttons {
    display: flex;
    gap: 8px;
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    padding: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(4px);
  }
  
  .dark .graph-buttons {
    background-color: rgba(33, 39, 53, 0.8);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
  }
  
  .graph-button {
    background-color: transparent;
    border: none;
    border-radius: 8px;
    padding: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    color: #555;
  }
  
  .dark .graph-button {
    color: #bbc6d8;
  }
  
  .graph-button:hover {
    background-color: rgba(79, 109, 245, 0.1);
    color: var(--color-primary);
    transform: translateY(-1px);
  }
  
  .dark .graph-button:hover {
    background-color: rgba(79, 109, 245, 0.2);
  }

  .graph-button.active {
    background-color: var(--color-primary, #4f6df5);
    color: white;
  }
  
  .graph-button.active:hover {
    background-color: #3d5bd7;
    color: white;
  }

  .graph-panel {
    position: absolute;
    top: 20px;
    left: 20px;
    max-width: 320px;
    max-height: 610px;
    overflow: hidden;
    z-index: 10;
    transition: all 0.3s ease;
  }

  .graph-info-panel {
    background-color: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(4px);
    margin-bottom: 10px;
    transition: all 0.3s ease;
    overflow: hidden;
  }

  .dark .graph-info-panel {
    background-color: rgba(33, 39, 53, 0.95);
    color: #eee;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
  }

  .panel-header {
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    position: relative;
  }

  .dark .panel-header {
    border-bottom-color: rgba(255, 255, 255, 0.05);
  }

  .panel-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--color-primary);
  }

  .dark .panel-header h3 {
    color: #7b96ff;
  }

  .panel-controls {
    display: flex;
    gap: 8px;
  }

  .panel-toggle {
    background: transparent;
    border: none;
    color: #8996a9;
    cursor: pointer;
    padding: 3px;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: transform 0.3s;
  }

  .panel-toggle.collapsed svg {
    transform: rotate(180deg);
  }

  .panel-content {
    padding: 15px 20px;
    overflow-y: auto;
    max-height: 500px;
    transition: all 0.3s ease;
  }

  .panel-content.collapsed {
    max-height: 0;
    padding: 0 20px;
    overflow: hidden;
  }

  .graph-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 20px;
    text-align: center;
  }

  .graph-stat {
    background: rgba(79, 109, 245, 0.05);
    padding: 10px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    transition: all 0.2s;
  }
  
  .dark .graph-stat {
    background: rgba(79, 109, 245, 0.1);
  }

  .graph-stat:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 8px rgba(79, 109, 245, 0.1);
  }

  .stat-label {
    font-size: 12px;
    font-weight: 500;
    margin-bottom: 5px;
    color: #666;
  }

  .dark .stat-label {
    color: #bbc6d8;
  }

  .stat-value {
    font-size: 18px;
    font-weight: 600;
    color: var(--color-primary, #4f6df5);
  }

  .dark .stat-value {
    color: #7b96ff;
  }

  .node-details {
    font-size: 14px;
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    padding-top: 15px;
  }

  .dark .node-details {
    border-top-color: rgba(255, 255, 255, 0.05);
  }

  .node-details h4 {
    margin: 0 0 15px 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--color-primary, #4f6df5);
  }

  .dark .node-details h4 {
    color: #7b96ff;
  }

  .node-details .node-meta {
    margin-bottom: 15px;
    background: rgba(0, 0, 0, 0.02);
    padding: 12px;
    border-radius: 8px;
  }

  .dark .node-details .node-meta {
    background: rgba(255, 255, 255, 0.03);
  }

  .node-details .node-meta div {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .node-details .node-meta div:last-child {
    margin-bottom: 0;
  }

  .node-details .node-links {
    border-top: 1px solid rgba(0, 0, 0, 0.05);
    padding-top: 15px;
  }

  .dark .node-details .node-links {
    border-top-color: rgba(255, 255, 255, 0.05);
  }

  .node-details .node-links h5 {
    margin: 0 0 10px 0;
    font-size: 14px;
    font-weight: 600;
    color: #555;
    display: flex;
    align-items: center;
  }
  
  .dark .node-details .node-links h5 {
    color: #bbc6d8;
  }
  
  .node-details .node-links h5 span {
    background: rgba(79, 109, 245, 0.1);
    color: var(--color-primary);
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 12px;
    margin-left: 8px;
  }

  .node-details .no-selection {
    color: #999;
    font-style: italic;
    text-align: center;
    padding: 40px 0;
  }

  .node-details .link-list {
    list-style: none;
    padding: 0;
    margin: 0 0 20px 0;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid rgba(0, 0, 0, 0.05);
    border-radius: 8px;
  }
  
  .dark .node-details .link-list {
    border-color: rgba(255, 255, 255, 0.05);
  }

  .node-details .link-list li {
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }
  
  .dark .node-details .link-list li {
    border-bottom-color: rgba(255, 255, 255, 0.05);
  }
  
  .node-details .link-list li:last-child {
    border-bottom: none;
  }

  .node-details .link-list a {
    color: var(--color-primary, #4f6df5);
    text-decoration: none;
    display: block;
    padding: 10px 12px;
    transition: all 0.2s;
  }

  .dark .node-details .link-list a {
    color: #7b96ff;
  }

  .node-details .link-list a:hover {
    background-color: rgba(79, 109, 245, 0.05);
  }
  
  .dark .node-details .link-list a:hover {
    background-color: rgba(79, 109, 245, 0.1);
  }
  
  /* D3.js グラフのスタイル */
  :global(.graph-node) {
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.17, 0.67, 0.83, 0.67);
    fill-opacity: 0.9;
  }
  
  :global(.graph-node:hover) {
    stroke: #f04050;
    stroke-width: 2.5px;
    fill-opacity: 1;
  }
  
  :global(.graph-node.current) {
    stroke-width: 3px;
    stroke: #f04050;
    fill-opacity: 1;
  }

  :global(.graph-node.selected) {
    stroke-width: 3.5px;
    stroke: #f04050;
    fill-opacity: 1;
    filter: url(#glow);
  }
  
  :global(.graph-link) {
    stroke-opacity: 0.5;
    transition: all 0.3s cubic-bezier(0.17, 0.67, 0.83, 0.67);
  }
  
  :global(.graph-link:hover) {
    stroke-opacity: 1;
    stroke-width: 2.5px;
  }
  
  :global(.graph-link.bidirectional) {
    stroke-width: 2.5px;
    stroke-dasharray: none;
  }
  
  :global(.graph-link.reference) {
    stroke-dasharray: 4, 2;
  }

  :global(.graph-link.highlighted) {
    stroke-opacity: 1;
    stroke-width: 3px;
    stroke: #f04050;
    filter: url(#glow);
  }
  
  :global(.node-label) {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 11px;
    font-weight: 500;
    pointer-events: none;
    text-anchor: middle;
    transition: all 0.3s;
    user-select: none;
    fill: #333;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
  }
  
  .dark :global(.node-label) {
    fill: #e8eef7;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
  }

  :global(.node-label.highlighted) {
    font-weight: 600;
    font-size: 13px;
    fill: #f04050;
    filter: url(#glow);
  }
  
  :global(.node-tooltip) {
    position: absolute;
    background-color: rgba(255, 255, 255, 0.95);
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 13px;
    pointer-events: none;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    backdrop-filter: blur(4px);
    z-index: 100;
    max-width: 280px;
    transition: all 0.2s cubic-bezier(0.17, 0.67, 0.83, 0.67);
    opacity: 0;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }
  
  .dark :global(.node-tooltip) {
    background-color: rgba(33, 39, 53, 0.95);
    color: #e8eef7;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    border-color: rgba(255, 255, 255, 0.05);
  }
  
  :global(.node-tooltip-title) {
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--color-primary);
    font-size: 14px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    padding-bottom: 6px;
  }
  
  .dark :global(.node-tooltip-title) {
    color: #7b96ff;
    border-bottom-color: rgba(255, 255, 255, 0.05);
  }
  
  :global(.node-tooltip-info) {
    font-size: 12px;
    color: #555;
    display: flex;
    align-items: center;
    margin-bottom: 4px;
  }
  
  :global(.node-tooltip-info:last-child) {
    margin-bottom: 0;
    margin-top: 8px;
    font-style: italic;
    color: #777;
  }
  
  .dark :global(.node-tooltip-info) {
    color: #bbc6d8;
  }
  
  .dark :global(.node-tooltip-info:last-child) {
    color: #96a3b9;
  }
  
  :global(.node-tooltip-info svg) {
    margin-right: 6px;
    color: var(--color-primary);
  }
  
  /* 内部凡例のスタイル */
  :global(.graph-legend) {
    position: absolute;
    top: 20px;
    right: 20px;
    background-color: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(4px);
    font-size: 13px;
    max-width: 230px;
    z-index: 10;
    transition: all 0.3s ease;
    transform-origin: top right;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }
  
  .dark :global(.graph-legend) {
    background-color: rgba(33, 39, 53, 0.95);
    color: #e8eef7;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    border-color: rgba(255, 255, 255, 0.05);
  }
  
  :global(.legend-title) {
    font-weight: 600;
    margin-bottom: 12px;
    font-size: 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--color-primary);
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    padding-bottom: 8px;
  }
  
  .dark :global(.legend-title) {
    color: #7b96ff;
    border-bottom-color: rgba(255, 255, 255, 0.05);
  }
  
  :global(.legend-title-text) {
    display: flex;
    align-items: center;
  }
  
  :global(.legend-title-text svg) {
    margin-right: 6px;
  }
  
  :global(.legend-close) {
    cursor: pointer;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background-color: rgba(0, 0, 0, 0.05);
    transition: all 0.2s;
  }
  
  :global(.legend-close:hover) {
    background-color: rgba(0, 0, 0, 0.1);
    transform: rotate(90deg);
  }
  
  .dark :global(.legend-close) {
    background-color: rgba(255, 255, 255, 0.1);
  }
  
  .dark :global(.legend-close:hover) {
    background-color: rgba(255, 255, 255, 0.15);
  }
  
  :global(.legend-group) {
    margin-bottom: 15px;
  }
  
  :global(.legend-group-title) {
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 13px;
    color: #333;
  }
  
  .dark :global(.legend-group-title) {
    color: #e8eef7;
  }
  
  :global(.legend-item) {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
    transition: all 0.2s;
    padding: 4px 6px;
    border-radius: 4px;
  }
  
  :global(.legend-item:hover) {
    background-color: rgba(0, 0, 0, 0.03);
    transform: translateX(2px);
  }
  
  .dark :global(.legend-item:hover) {
    background-color: rgba(255, 255, 255, 0.05);
  }
  
  :global(.legend-color) {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    margin-right: 10px;
    display: inline-block;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
  }
  
  .dark :global(.legend-color) {
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
  }
  
  :global(.legend-line) {
    width: 25px;
    height: 3px;
    margin-right: 10px;
    border-radius: 3px;
  }

  /* ノードのジャンプリンク */
  :global(.node-jump-link) {
    position: absolute;
    background-color: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 5px 12px;
    font-size: 13px;
    text-decoration: none;
    color: var(--color-primary);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    z-index: 5;
    transition: all 0.3s cubic-bezier(0.17, 0.67, 0.83, 0.67);
    opacity: 0;
    transform: translateY(10px);
    pointer-events: none;
    border: 1px solid rgba(0, 0, 0, 0.05);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  :global(.node-jump-link.visible) {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  :global(.node-jump-link:hover) {
    background-color: var(--color-primary);
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(79, 109, 245, 0.3);
  }
  
  .dark :global(.node-jump-link) {
    background-color: rgba(33, 39, 53, 0.95);
    border-color: rgba(255, 255, 255, 0.05);
    color: #7b96ff;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }

  .dark :global(.node-jump-link:hover) {
    background-color: var(--color-primary);
    color: white;
    box-shadow: 0 5px 15px rgba(79, 109, 245, 0.3);
  }

  /* レスポンシブ対応 */
  @media (max-width: 768px) {
    .graph-controls {
      bottom: 15px;
      right: 15px;
    }
    
    .graph-search {
      width: 180px;
    }
    
    .graph-buttons {
      flex-wrap: wrap;
      justify-content: center;
      max-width: 180px;
    }
    
    .graph-button {
      padding: 7px;
    }

    .graph-panel {
      position: static;
      max-width: 100%;
      margin: 15px;
    }
    
    .graph-stats {
      grid-template-columns: 1fr 1fr;
    }

    .graph-info-panel {
      margin-bottom: 0;
    }

    .full-graph {
      height: 450px;
    }
    
    .mini-graph {
      height: 250px;
    }
    
    :global(.graph-legend) {
      top: 15px;
      right: 15px;
      padding: 12px;
      max-width: 200px;
    }
  }

  @media (max-width: 480px) {
    .graph-panel {
      margin: 10px;
    }
    
    .graph-stats {
      grid-template-columns: 1fr;
    }
    
    .graph-controls {
      bottom: 10px;
      right: 10px;
    }
    
    .graph-search {
      width: 150px;
    }
    
    .graph-search input {
      padding: 6px 10px 6px 30px;
      font-size: 13px;
    }
    
    .search-icon {
      left: 8px;
    }
    
    .graph-buttons {
      max-width: 150px;
      padding: 4px;
    }
    
    .graph-button {
      padding: 6px;
    }
    
    .full-graph {
      height: 400px;
    }
    
    :global(.graph-legend) {
      max-width: 180px;
      padding: 10px;
    }
  }
</style>

<script>
  // D3.jsを使用したグラフの描画
  document.addEventListener('DOMContentLoaded', () => {
    // 必要なライブラリを動的にロード
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/d3@7';
    script.onload = initGraph;
    document.head.appendChild(script);
    
    // パネルの折りたたみ機能
    const togglePanelBtn = document.getElementById('toggle-panel');
    if (togglePanelBtn) {
      togglePanelBtn.addEventListener('click', () => {
        const panelContent = document.querySelector('.panel-content');
        const isCollapsed = panelContent.classList.contains('collapsed');
        
        if (isCollapsed) {
          panelContent.classList.remove('collapsed');
          togglePanelBtn.classList.remove('collapsed');
        } else {
          panelContent.classList.add('collapsed');
          togglePanelBtn.classList.add('collapsed');
        }
      });
    }
    
    function initGraph() {
      const graphElement = document.getElementById('knowledge-graph');
      if (!graphElement) return;
      
      // コンテナデータ
      const graphData = JSON.parse(graphElement.getAttribute('data-graph') || '{"nodes":[],"links":[]}');
      const isFullGraph = graphElement.classList.contains('full-graph');
      const currentId = parseInt(graphElement.getAttribute('data-current-id') || '0', 10);
      
      // グラフの読み込み中表示を削除
      graphElement.querySelector('.graph-loading')?.remove();
      
      // SVG要素の作成
      const width = graphElement.clientWidth;
      const height = graphElement.clientHeight;
      
      const svg = d3.select('#knowledge-graph')
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .attr('viewBox', [0, 0, width, height]);
      
      // SVGフィルター定義（グロー効果）
      const defs = svg.append('defs');
      
      // グロー効果フィルター
      const filter = defs.append('filter')
        .attr('id', 'glow')
        .attr('x', '-50%')
        .attr('y', '-50%')
        .attr('width', '200%')
        .attr('height', '200%');
        
      filter.append('feGaussianBlur')
        .attr('stdDeviation', '2.5')
        .attr('result', 'coloredBlur');
        
      const feMerge = filter.append('feMerge');
      feMerge.append('feMergeNode')
        .attr('in', 'coloredBlur');
      feMerge.append('feMergeNode')
        .attr('in', 'SourceGraphic');
      
      // ズーム機能の定義
      const zoom = d3.zoom()
        .scaleExtent([0.1, 5])
        .on('zoom', (event) => {
          container.attr('transform', event.transform);
          // ズームレベルに応じてラベルの表示を調整
          adjustLabels(event.transform.k);
          // ジャンプリンクの位置を更新
          updateJumpLinks();
        });
      
      // SVGにズーム機能を追加
      svg.call(zoom);
      
      // グループコンテナ（ズーム用）
      const container = svg.append('g')
        .attr('class', 'graph-container');
      
      // リンクを描画するためのグループ
      const link = container.append('g')
        .attr('class', 'links')
        .selectAll('line')
        .data(graphData.links)
        .enter().append('line')
        .attr('class', d => `graph-link ${d.bidirectional ? 'bidirectional' : ''} ${d.type || ''}`)
        .attr('stroke', d => d.bidirectional ? '#0fa968' : '#999')
        .attr('stroke-width', d => d.bidirectional ? 2.5 : 1.5);
      
      // ノードを描画するためのグループ
      const node = container.append('g')
        .attr('class', 'nodes')
        .selectAll('circle')
        .data(graphData.nodes)
        .enter().append('circle')
        .attr('class', d => `graph-node ${d.isCurrent ? 'current' : ''}`)
        .attr('r', d => d.isCurrent ? 9 : getNodeSize(d))
        .attr('fill', d => d.isCurrent ? '#f04050' : getNodeColor(d))
        .attr('data-id', d => d.id)
        .attr('data-url', d => d.url)
        .on('mouseover', nodeMouseOver)
        .on('mouseout', nodeMouseOut)
        .on('click', nodeClicked)
        .on('dblclick', nodeDoubleClicked);
      
      // ラベルの描画（デフォルトでは表示）
      const label = container.append('g')
        .attr('class', 'labels')
        .selectAll('text')
        .data(graphData.nodes)
        .enter().append('text')
        .attr('class', d => `node-label ${d.isCurrent ? 'current' : ''}`)
        .attr('dy', d => d.isCurrent ? '-1.5em' : '-1em')
        .text(d => truncateLabel(d.title))
        .style('opacity', 1); // デフォルトで全てのラベルを表示
      
      // ジャンプリンク用のコンテナ
      const jumpLinksContainer = d3.select('#knowledge-graph').append('div')
        .attr('class', 'jump-links-container')
        .style('position', 'absolute')
        .style('top', 0)
        .style('left', 0)
        .style('width', '100%')
        .style('height', '100%')
        .style('pointer-events', 'none');
        
      // 各ノードに対するジャンプリンクを作成
      graphData.nodes.forEach(nodeData => {
        jumpLinksContainer.append('a')
          .attr('class', 'node-jump-link')
          .attr('id', `jump-link-${nodeData.id}`)
          .attr('href', nodeData.url)
          .attr('target', isFullGraph ? '_blank' : '_self')
          .html(`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>ページへ`)
          .style('display', 'none');
      });
      
      // ツールチップの作成
      const tooltip = d3.select('body').append('div')
        .attr('class', 'node-tooltip')
        .style('opacity', 0);
      
      // 凡例の追加（グラフ内に直接表示）
      if (isFullGraph) {
        const legend = d3.select('#knowledge-graph')
          .append('div')
          .attr('class', 'graph-legend')
          .style('display', 'block'); // デフォルトでは表示
        
        legend.append('div')
          .attr('class', 'legend-title')
          .html('<div class="legend-title-text"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>グラフ凡例</div> <div class="legend-close">×</div>');
        
        // ノードタイプの凡例グループ
        const nodeTypesGroup = legend.append('div')
          .attr('class', 'legend-group');
          
        nodeTypesGroup.append('div')
          .attr('class', 'legend-group-title')
          .text('ノードタイプ');
        
        const nodeTypes = [
          { name: '通常ページ', color: '#4f6df5' },
          { name: '現在のページ', color: '#f04050' },
          { name: 'ドキュメント', color: '#0075ca' },
          { name: 'Wiki', color: '#7057ff' },
          { name: '機能', color: '#a2eeef' }
        ];
        
        nodeTypes.forEach(type => {
          nodeTypesGroup.append('div')
            .attr('class', 'legend-item')
            .html(`<span class="legend-color" style="background-color: ${type.color};"></span>${type.name}`);
        });
        
        // 線タイプの凡例グループ
        const linkTypesGroup = legend.append('div')
          .attr('class', 'legend-group');
          
        linkTypesGroup.append('div')
          .attr('class', 'legend-group-title')
          .text('リンクタイプ');
        
        linkTypesGroup.append('div')
          .attr('class', 'legend-item')
          .html('<span class="legend-line" style="background-color: #999;"></span>片方向リンク');
        
        linkTypesGroup.append('div')
          .attr('class', 'legend-item')
          .html('<span class="legend-line" style="background-color: #0fa968;"></span>双方向リンク');
        
        // 凡例ボタンのイベント
        d3.select('#toggle-legend').on('click', () => {
          const legendElem = d3.select('.graph-legend');
          const isVisible = legendElem.style('display') !== 'none';
          legendElem.style('display', isVisible ? 'none' : 'block');
          d3.select('#toggle-legend').classed('active', !isVisible);
        });
        
        // 凡例の閉じるボタン
        d3.select('.legend-close').on('click', () => {
          d3.select('.graph-legend').style('display', 'none');
          d3.select('#toggle-legend').classed('active', false);
        });

        // ラベル表示切り替え（デフォルトでオン）
        const toggleLabelsBtn = d3.select('#toggle-labels');
        toggleLabelsBtn.classed('active', true);
        
        toggleLabelsBtn.on('click', function() {
          const button = d3.select(this);
          const showLabels = button.classed('active');
          
          button.classed('active', !showLabels);
          
          if (showLabels) {
            // ラベルを非表示
            label.style('opacity', d => d.isCurrent ? 1 : 0);
          } else {
            // ラベルを表示
            label.style('opacity', 1);
          }
        });

        // 物理シミュレーション切り替え
        let simulationRunning = true;
        d3.select('#toggle-physics').classed('active', true).on('click', function() {
          const button = d3.select(this);
          simulationRunning = !simulationRunning;
          
          button.classed('active', simulationRunning);
          
          if (simulationRunning) {
            simulation.alpha(0.3).restart();
          } else {
            simulation.stop();
          }
        });

        // レイアウト最適化ボタン
        d3.select('#optimize-layout').on('click', function() {
          // 現在のシミュレーション設定を保存
          const wasRunning = simulationRunning;
          
          // 最適化中表示
          const button = d3.select(this);
          button.classed('active', true).attr('disabled', true)
               .html('<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8V3"></path><path d="M21 3v5h-5"></path></svg>');
          
          // 一時的にシミュレーションを再開し、強度を変更
          simulation
            .force('charge', d3.forceManyBody().strength(-600))  // より強い反発力
            .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(120))  // リンク距離を広げる
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('x', d3.forceX(width / 2).strength(0.1))  // X方向の力を追加
            .force('y', d3.forceY(height / 2).strength(0.1))  // Y方向の力を追加
            .force('collision', d3.forceCollide().radius(35))  // 衝突回避を強化
            .alpha(0.8)  // アルファ値を高く設定して激しく動かす
            .restart();
          
          // 最適化アニメーション
          setTimeout(() => {
            // 中間段階
            simulation
              .force('charge', d3.forceManyBody().strength(-450))
              .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(100))
              .alpha(0.5)
              .restart();
              
            setTimeout(() => {
              // 元の設定に戻す
              simulation
                .force('charge', d3.forceManyBody().strength(isFullGraph ? -300 : -200))
                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(isFullGraph ? 100 : 80))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('x', null)  // 追加の力を削除
                .force('y', null)
                .force('collision', d3.forceCollide().radius(20));
              
              if (!wasRunning) {
                simulation.stop();
              } else {
                simulation.alpha(0.3).restart();
              }
              
              button.classed('active', false).attr('disabled', null)
                   .html('<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><circle cx="15.5" cy="8.5" r="1.5"></circle><circle cx="15.5" cy="15.5" r="1.5"></circle><circle cx="8.5" cy="15.5" r="1.5"></circle></svg>');
            }, 1500);
          }, 1500);
        });

        // ノード検索
        d3.select('#node-search').on('input', function() {
          const searchTerm = this.value.toLowerCase();
          
          if (!searchTerm) {
            // 検索がクリアされたら元の表示に戻す
            node.style('opacity', 1);
            link.style('opacity', 0.5);
            label.style('opacity', d => 
              d3.select('#toggle-labels').classed('active') ? 1 : (d.isCurrent ? 1 : 0)
            ).classed('highlighted', false);
            return;
          }
          
          // マッチするノードを検索
          const matchingNodes = graphData.nodes.filter(d => 
            d.title.toLowerCase().includes(searchTerm)
          );
          
          const matchingIds = new Set(matchingNodes.map(d => d.id));
          
          // マッチするノードを強調
          node.style('opacity', d => matchingIds.has(d.id) ? 1 : 0.2);
          
          // マッチするノードに関連するリンクを強調
          link.style('opacity', d => 
            matchingIds.has(d.source.id) && matchingIds.has(d.target.id) ? 0.8 : 0.1
          );
          
          // マッチするノードのラベルを表示
          label
            .style('opacity', d => matchingIds.has(d.id) ? 1 : 0.1)
            .classed('highlighted', d => matchingIds.has(d.id));
        });
      }
      
      // ノードの色を決定する関数
      function getNodeColor(node) {
        if (node.isCurrent) return '#f04050';
        if (node.labels && node.labels.length > 0) {
          if (node.labels.includes('documentation')) return '#0075ca';
          if (node.labels.includes('feature')) return '#a2eeef';
          if (node.labels.includes('wiki')) return '#7057ff';
        }
        return '#4f6df5';
      }

      // ノードのサイズを決定する関数
      function getNodeSize(node) {
        // コメント数に応じてサイズを変更
        const baseSize = 6;
        if (node.comments > 10) return baseSize + 4;
        if (node.comments > 5) return baseSize + 2;
        if (node.comments > 0) return baseSize + 1;
        return baseSize;
      }
      
      // ラベルを短縮する関数
      function truncateLabel(text) {
        return text.length > 15 ? text.substring(0, 15) + '...' : text;
      }
      
      // ズームレベルに応じてラベルの表示を調整する関数
      function adjustLabels(zoomLevel) {
        // ズームレベルに応じてラベルの透明度を調整
        if (isFullGraph) {
          const showLabels = d3.select('#toggle-labels').classed('active');
          if (showLabels) {
            label.style('opacity', zoomLevel < 0.7 ? 0 : 1);
          } else {
            label.style('opacity', d => d.isCurrent ? 1 : 0);
          }
        } else {
          label.style('opacity', zoomLevel < 0.7 ? 0 : 1);
        }
      }

      // ジャンプリンクの位置を更新する関数
      function updateJumpLinks() {
        // 表示されているジャンプリンクを更新
        const activeNode = document.querySelector('.graph-node.active');
        if (activeNode) {
          const nodeId = activeNode.getAttribute('data-id');
          const nodePosition = activeNode.getBoundingClientRect();
          const containerPosition = graphElement.getBoundingClientRect();
          
          const jumpLink = document.getElementById(`jump-link-${nodeId}`);
          if (jumpLink) {
            // グラフ内の相対位置を計算
            const relativeLeft = nodePosition.left - containerPosition.left;
            const relativeTop = nodePosition.top - containerPosition.top;
            
            // ジャンプリンクの位置を更新
            jumpLink.style.left = `${relativeLeft}px`;
            jumpLink.style.top = `${relativeTop + nodePosition.height / 2 + 15}px`;
          }
        }
      }

      // 選択されたノードの詳細を表示する関数
      function showNodeDetails(node) {
        const nodeDetails = document.getElementById('node-details');
        if (!nodeDetails) return;

        // 日付フォーマット
        const formatDate = (dateString) => {
          const date = new Date(dateString);
          return date.toLocaleDateString('ja-JP', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          });
        };

        // 入リンク・出リンクを取得
        const incomingLinks = graphData.links.filter(l => l.target.id === node.id);
        const outgoingLinks = graphData.links.filter(l => l.source.id === node.id);

        // HTMLを構築
        let html = `
          <h4>${node.title}</h4>
          <div class="node-meta">
            <div><span>Issue番号:</span> <span>#${node.id}</span></div>
            <div><span>作成日:</span> <span>${formatDate(node.created_at)}</span></div>
            <div><span>更新日:</span> <span>${formatDate(node.updated_at)}</span></div>
            <div><span>コメント数:</span> <span>${node.comments}</span></div>
            ${node.labels && node.labels.length ? 
              `<div><span>ラベル:</span> <span>${node.labels.join(', ')}</span></div>` : 
              ''}
            <div><span>アクション:</span> <span><a href="${node.url}" target="_blank">記事を開く</a></span></div>
          </div>
        `;

        // リンク情報
        html += `<div class="node-links">`;
        
        // 入リンク
        html += `<h5>入リンク <span>${incomingLinks.length}</span></h5>`;
        if (incomingLinks.length > 0) {
          html += `<ul class="link-list">`;
          incomingLinks.forEach(l => {
            const sourceNode = graphData.nodes.find(n => n.id === l.source.id);
            html += `<li><a href="${sourceNode.url}" title="${sourceNode.title}">${sourceNode.title}</a></li>`;
          });
          html += `</ul>`;
        } else {
          html += `<p>このノードを参照しているページはありません</p>`;
        }

        // 出リンク
        html += `<h5>出リンク <span>${outgoingLinks.length}</span></h5>`;
        if (outgoingLinks.length > 0) {
          html += `<ul class="link-list">`;
          outgoingLinks.forEach(l => {
            const targetNode = graphData.nodes.find(n => n.id === l.target.id);
            html += `<li><a href="${targetNode.url}" title="${targetNode.title}">${targetNode.title}</a></li>`;
          });
          html += `</ul>`;
        } else {
          html += `<p>このノードから他のページへのリンクはありません</p>`;
        }

        html += `</div>`;

        nodeDetails.innerHTML = html;
      }

      // リンクの強調表示
      function highlightNodeLinks(nodeId, highlight = true) {
        // 関連リンクを強調
        link
          .classed('highlighted', d => 
            highlight && (d.source.id === nodeId || d.target.id === nodeId)
          )
          .style('opacity', d => 
            highlight 
              ? (d.source.id === nodeId || d.target.id === nodeId ? 1 : 0.1)
              : 0.5
          );

        // 関連ノードとラベルを強調
        const connectedNodeIds = new Set();
        if (highlight) {
          graphData.links.forEach(l => {
            if (l.source.id === nodeId) connectedNodeIds.add(l.target.id);
            if (l.target.id === nodeId) connectedNodeIds.add(l.source.id);
          });
          connectedNodeIds.add(nodeId);
        }

        node
          .classed('selected', d => highlight && d.id === nodeId)
          .classed('active', d => highlight && d.id === nodeId)
          .style('opacity', d => 
            highlight 
              ? (connectedNodeIds.has(d.id) ? 1 : 0.2)
              : 1
          );

        const showLabels = d3.select('#toggle-labels').classed('active');
        label
          .classed('highlighted', d => highlight && d.id === nodeId)
          .style('opacity', d => {
            if (!isFullGraph) return 1;
            if (d.isCurrent) return 1;
            if (d.id === nodeId) return 1;
            if (highlight && connectedNodeIds.has(d.id)) return 1;
            return showLabels ? 0.7 : 0;
          });

        // ジャンプリンクの表示/非表示
        const jumpLinkElements = document.querySelectorAll('.node-jump-link');
        jumpLinkElements.forEach(el => {
          el.style.display = 'none';
          el.classList.remove('visible');
        });

        if (highlight) {
          const jumpLink = document.getElementById(`jump-link-${nodeId}`);
          if (jumpLink) {
            jumpLink.style.display = 'block';
            
            // アクティブなノードの位置を取得
            const activeNode = document.querySelector(`.graph-node[data-id="${nodeId}"]`);
            if (activeNode) {
              const nodePosition = activeNode.getBoundingClientRect();
              const containerPosition = graphElement.getBoundingClientRect();
              
              // グラフ内の相対位置を計算
              const relativeLeft = nodePosition.left - containerPosition.left;
              const relativeTop = nodePosition.top - containerPosition.top;
              
              // ジャンプリンクの位置を設定
              jumpLink.style.left = `${relativeLeft}px`;
              jumpLink.style.top = `${relativeTop + 15}px`;
              
              // 表示アニメーション
              setTimeout(() => {
                jumpLink.classList.add('visible');
              }, 10);
            }
          }
        }
      }
      
      // ノードのマウスオーバー処理
      function nodeMouseOver(event, d) {
        // ノードを強調表示
        d3.select(this)
          .transition()
          .duration(200)
          .attr('r', d.isCurrent ? 12 : getNodeSize(d) + 3);
        
        // 関連リンク、ノード、ラベルを強調
        if (isFullGraph) {
          highlightNodeLinks(d.id);
        } else {
          // ミニグラフの場合はより単純な強調表示
          link.transition()
            .duration(200)
            .style('opacity', l => 
              l.source.id === d.id || l.target.id === d.id ? 1 : 0.1);
          
          node.transition()
            .duration(200)
            .style('opacity', n => 
              n.id === d.id || 
              graphData.links.some(l => 
                (l.source.id === d.id && l.target.id === n.id) || 
                (l.target.id === d.id && l.source.id === n.id)
              ) ? 1 : 0.3);
          
          label.transition()
            .duration(200)
            .style('opacity', n => 
              n.id === d.id || 
              graphData.links.some(l => 
                (l.source.id === d.id && l.target.id === n.id) || 
                (l.target.id === d.id && l.source.id === n.id)
              ) ? 1 : 0.1);
        }
        
        // ツールチップを表示
        tooltip.transition()
          .duration(200)
          .style('opacity', 0.9);
        
        const tooltipContent = `
          <div class="node-tooltip-title">${d.title}</div>
          <div class="node-tooltip-info">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="16"></line>
              <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
            Issue #${d.id}
          </div>
          ${d.labels && d.labels.length > 0 ? 
            `<div class="node-tooltip-info">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                <line x1="7" y1="7" x2="7.01" y2="7"></line>
              </svg>
              ${d.labels.join(', ')}
            </div>` : ''}
          ${d.comments > 0 ? 
            `<div class="node-tooltip-info">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              コメント数: ${d.comments}
            </div>` : ''}
          <div class="node-tooltip-info">クリックで詳細表示 | ダブルクリックで記事へ</div>
        `;
        
        tooltip.html(tooltipContent)
          .style('left', (event.pageX + 15) + 'px')
          .style('top', (event.pageY - 28) + 'px');
      }
      
      // ノードのマウスアウト処理
      function nodeMouseOut(event, d) {
        // ノードを元に戻す
        d3.select(this)
          .transition()
          .duration(200)
          .attr('r', d.isCurrent ? 9 : getNodeSize(d));
        
        // リンク、ノード、ラベルを元に戻す
        if (isFullGraph) {
          // 選択状態のノードが存在するかチェック
          const selectedNode = node.filter('.selected');
          if (selectedNode.size() > 0) {
            // 選択状態のノードがあれば、そのノードの強調を維持
            const selectedId = selectedNode.datum().id;
            highlightNodeLinks(selectedId);
          } else {
            // 選択状態のノードがなければ、すべて通常表示に戻す
            highlightNodeLinks(null, false);
          }
        } else {
          // ミニグラフの場合の処理
          link.transition()
            .duration(200)
            .style('opacity', 0.5);
          
          node.transition()
            .duration(200)
            .style('opacity', 1);
          
          label.transition()
            .duration(200)
            .style('opacity', 1);
        }
        
        // ツールチップを非表示
        tooltip.transition()
          .duration(200)
          .style('opacity', 0);
      }
      
      // ノードクリック時の挙動
      function nodeClicked(event, d) {
        if (event.defaultPrevented) return;
        event.preventDefault();
        
        if (isFullGraph) {
          // 現在のノードが選択されているか
          const isCurrentlySelected = d3.select(this).classed('selected');
          
          // すべてのノードから選択状態を解除
          node.classed('selected', false).classed('active', false);
          
          if (!isCurrentlySelected) {
            // 選択状態にして詳細を表示
            d3.select(this).classed('selected', true).classed('active', true);
            highlightNodeLinks(d.id);
            showNodeDetails(d);
            
            // パネルが閉じている場合、開く
            const panelContent = document.querySelector('.panel-content');
            const togglePanelBtn = document.getElementById('toggle-panel');
            if (panelContent.classList.contains('collapsed')) {
              panelContent.classList.remove('collapsed');
              togglePanelBtn.classList.remove('collapsed');
            }
          } else {
            // 選択解除
            highlightNodeLinks(null, false);
            document.getElementById('node-details').innerHTML = 
              '<div class="no-selection">ノードを選択すると詳細が表示されます</div>';
          }
        } else {
          // ミニグラフの場合は直接ジャンプリンクを表示
          const nodeId = d.id;
          const jumpLink = document.getElementById(`jump-link-${nodeId}`);
          
          if (jumpLink) {
            const nodePosition = event.target.getBoundingClientRect();
            const containerPosition = graphElement.getBoundingClientRect();
            
            // グラフ内の相対位置を計算
            const relativeLeft = nodePosition.left - containerPosition.left;
            const relativeTop = nodePosition.top - containerPosition.top;
            
            // ジャンプリンクの位置を設定して表示
            jumpLink.style.display = 'block';
            jumpLink.style.left = `${relativeLeft}px`;
            jumpLink.style.top = `${relativeTop + 15}px`;
            
            // 表示アニメーション
            setTimeout(() => {
              jumpLink.classList.add('visible');
            }, 10);
            
            // 他のジャンプリンクを非表示
            document.querySelectorAll('.node-jump-link').forEach(el => {
              if (el.id !== `jump-link-${nodeId}`) {
                el.style.display = 'none';
                el.classList.remove('visible');
              }
            });
          }
        }
      }
      
      // ノードダブルクリック時の挙動
      function nodeDoubleClicked(event, d) {
        event.preventDefault();
        
        // 記事ページに直接ジャンプ
        window.location.href = d.url;
      }
      
      // シミュレーションの設定
      const simulation = d3.forceSimulation(graphData.nodes)
        .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(isFullGraph ? 100 : 80))
        .force('charge', d3.forceManyBody().strength(isFullGraph ? -300 : -200))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(20)) // ノード間の衝突回避
        .on('tick', ticked);
      
      // シミュレーション更新時の描画更新
      function ticked() {
        link
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);
        
        node
          .attr('cx', d => d.x = Math.max(20, Math.min(width - 20, d.x)))
          .attr('cy', d => d.y = Math.max(20, Math.min(height - 20, d.y)));
        
        label
          .attr('x', d => d.x)
          .attr('y', d => d.y - 10);
          
        // アクティブなノードのジャンプリンク位置を更新
        updateJumpLinks();
      }
      
      // ズームコントロールのイベントハンドラー
      if (isFullGraph) {
        // ズームイン
        document.getElementById('zoom-in')?.addEventListener('click', () => {
          svg.transition().duration(300).call(
            zoom.scaleBy, 1.3
          );
        });
        
        // ズームアウト
        document.getElementById('zoom-out')?.addEventListener('click', () => {
          svg.transition().duration(300).call(
            zoom.scaleBy, 1 / 1.3
          );
        });
        
        // リセット
        document.getElementById('reset-graph')?.addEventListener('click', () => {
          svg.transition().duration(300).call(
            zoom.transform, d3.zoomIdentity
          );
        });
      }
      
      // 現在のノードにスクロールしてフォーカス
      if (currentId) {
        const currentNode = graphData.nodes.find(n => n.id === currentId);
        if (currentNode && isFullGraph) {
          setTimeout(() => {
            svg.transition().duration(800).call(
              zoom.transform, 
              d3.zoomIdentity
                .translate(width / 2, height / 2)
                .scale(1.3)
                .translate(-currentNode.x, -currentNode.y)
            );
          }, 800);
        }
      }
      
      // ウィンドウサイズ変更時の処理
      window.addEventListener('resize', () => {
        const newWidth = graphElement.clientWidth;
        const newHeight = graphElement.clientHeight;
        
        svg.attr('width', newWidth)
           .attr('height', newHeight)
           .attr('viewBox', [0, 0, newWidth, newHeight]);
        
        // 中心位置を更新
        simulation.force('center', d3.forceCenter(newWidth / 2, newHeight / 2));
        simulation.alpha(0.3).restart();
        
        // ジャンプリンクの位置を更新
        updateJumpLinks();
      });
    }
  });
</script>

<script is:inline define:vars={{dataJson}}>
  document.addEventListener('DOMContentLoaded', () => {
    const graph = document.getElementById('knowledge-graph');
    if (graph) {
      graph.setAttribute('data-graph', dataJson);
    }
  });
</script>
